# A. å…¨éƒ¨é¡µé¢ä¸€è§ˆï¼ˆæŒ‰çŠ¶æ€å®Œæ•´è¦†ç›–ï¼‰

> è®¾å¤‡ï¼š**2.33-inch æ¨ªå± 222Ã—480**
> çº¦æŸï¼š**å›ºå®š TopBarï¼ˆBack / Title / Batteryï¼‰**
> åŸåˆ™ï¼š**ESPâ€‘NOW è¿‘è·å»ºé˜Ÿï¼ˆâ‰¤5mï¼‰**ï¼›ä¸ä½¿ç”¨ LoRa/NFCï¼›é…å¯¹ä»…åœ¨å¯¹åº”é¡µé¢å¯ç”¨ï¼ˆçœç”µ/é¿å…è¯¯è§¦ï¼‰

---

## A0. å…¨å±€ UI éª¨æ¶ï¼ˆå¤ç”¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back          [ TITLE / CONTEXT ]        ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚                CONTENT AREA                  â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   [ Action 1 ]        [ Action 2 ]            â”‚  (å¯é€‰)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## A1. Team çŠ¶æ€å…¥å£é¡µï¼ˆæœªåŠ å…¥ï¼‰

**Titleï¼š`Team`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back                 Team               ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚        You are not in a team                  â”‚
â”‚                                              â”‚
â”‚   â€¢ No shared map                             â”‚
â”‚   â€¢ No team awareness                         â”‚
â”‚                                              â”‚
â”‚   Create or join a team                       â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Create (ESP?NOW) ]      [ Join (ESP?NOW) ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## A2. Team çŠ¶æ€å…¥å£é¡µï¼ˆå·²åŠ å…¥ï¼‰

**Titleï¼š`Team Status`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back            Team Status             ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Team: ALPHA-7   (ID: A7K3)                   â”‚
â”‚  Role:        Member                          â”‚
â”‚  Members:     5   Online: 3                   â”‚
â”‚  Security:    OK   (Epoch 5)                  â”‚
â”‚  Sync:        OK   (Last event 128)           â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Team Health                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â— Leader online                              â”‚
â”‚  â— Last update 18s ago                        â”‚
â”‚  â—‹ 1 member stale                             â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ View Team ]     [ Pair Member ]     [ Leave ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> è¿™æ˜¯ **åˆ¤æ–­â€œé˜Ÿä¼æ˜¯å¦è¿˜å¯ä¿¡ / æ˜¯å¦å¯¹é½â€** çš„é¡µé¢
> ä¸æ˜¯ç®¡ç†é¡µ

---

## A3. Team Homeï¼ˆæˆå‘˜ä¸ç»“æ„ï¼ŒLeader/Member é€šç”¨ï¼‰

**Titleï¼š`Team Â· Leader` æˆ– `Team Â· Member`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back          Team Â· Leader              ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Team: ALPHA-7 (ID: A7K3)                     â”‚
â”‚  Members: 3      Online: 2                    â”‚
â”‚  Epoch: 5        Sync: OK (128)               â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚  (ä»… Leader ä¸”æœ‰è¯·æ±‚æ—¶æ˜¾ç¤º)
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Members                                     â”‚
â”‚  â— You (Leader)        Online                 â”‚
â”‚  â— Tom                 Online                 â”‚
â”‚  â—‹ Jerry               Last seen 2m ago       â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Pair Member ]        [ Manage ]     [ Leave ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> é‡è¦ï¼šæˆ·å¤–åœºæ™¯ä¸‹ç”¨æˆ·ç»å¸¸åœ¨åœ°å›¾/èŠå¤©é¡µï¼Œä¸ä¸€å®šçœ‹å¾—åˆ° popup

---

## A3b. Pairing?ESP?NOW?
**Title?`Pairing`**

- ??????? ESP?NOW ??????? 120s?
- Leader?????????????????
- Member??? beacon??? join ????? KeyDist
- UI ???Scanning / Join sent / Waiting for keys / Completed / Failed
- ???[Cancel] ?????[Retry] ????

---

## A7. Members ç®¡ç†é¡µï¼ˆLeaderï¼‰

**Titleï¼š`Members`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back             Members               ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â— You (Leader)                               â”‚
â”‚                                              â”‚
â”‚  â— Tom                                       â”‚
â”‚     > Select                                  â”‚
â”‚                                              â”‚
â”‚  â—‹ Jerry                                     â”‚
â”‚     > Select                                  â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## A8. Member Detailï¼ˆLeaderï¼‰

**Titleï¼š`Member: Jerry`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back          Member: Jerry             ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Status:   Last seen 2m ago                   â”‚
â”‚  Role:     Member                             â”‚
â”‚                                              â”‚
â”‚  Device:   Pager                              â”‚
â”‚  Capability:                                  â”‚
â”‚   â€¢ Position                                  â”‚
â”‚   â€¢ Waypoint                                  â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Kick ]        [ Transfer Leader ]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## A9. Kick ç¡®è®¤é¡µï¼ˆå®‰å…¨å…³é”®ï¼‰

**Titleï¼š`Kick Member`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back             Kick Member            ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Remove Jerry from team?                      â”‚
â”‚                                              â”‚
â”‚  This will update the security round (epoch). â”‚
â”‚  Jerry will no longer receive team updates.   â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Cancel ]              [ Confirm Kick ]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## A9b. Leave ç¡®è®¤å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back            Leave team?            ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  This clears local keys.                     â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Cancel ]              [ Leave ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> Leave éœ€è¦äºŒæ¬¡ç¡®è®¤ï¼Œé¿å…è¯¯è§¦å¯¼è‡´æœ¬åœ°å¯†é’¥è¢«æ¸…ç©º

---

## A10. Access Lostï¼ˆMemberï¼šè¢«è¸¢ / å¤±æ•ˆ / ä¸ä¸€è‡´ï¼‰

**Titleï¼š`Team`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ < Back               Team                ğŸ”‹ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Access lost                                  â”‚
â”‚                                              â”‚
â”‚  Reason:  [ Revoked | Out-of-sync | Unknown ] â”‚
â”‚                                              â”‚
â”‚  â€¢ Revoked: removed by leader                 â”‚
â”‚  â€¢ Out-of-sync: team updated, sync required   â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Try Sync ]   [ Join Another Team ]   [ OK ]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> å…³é”®ï¼šåŒºåˆ†â€œè¢«è¸¢â€ vs â€œå¯†é’¥/epoch ä¸ä¸€è‡´â€ï¼Œå‡å°‘è¯¯åˆ¤
> `Try Sync` åªåœ¨ Out-of-sync æ—¶å¯ç”¨

---

# B. é¡µé¢æµè½¬è¯´æ˜ï¼ˆUI çŠ¶æ€æœºï¼‰

## B1. é¡¶å±‚æµè½¬ï¼ˆç®€åŒ–ï¼‰

```
[ Team Menu ]
     |
     v
[ Team Status ]
     |
     +--> (not in team) --> [ Create (ESP?NOW) ] -> [ Team Status (joined) ]
     |
     +--> (joined) -------> [ View Team ] -> [ Team Home ]
```

---

## B2. ?????Member?ESP?NOW?
```
[ Team Status (not in team) ]
        |
        v
     [ Pairing ]
        |
        +-- scanning -> join sent -> waiting key -> [ Team Status (joined) ]
        |
        +-- timeout/cancel ----------------------> [ Team Status (not in team) ]
```

---

## B3. ?????Leader?ESP?NOW?
```
[ Team Status (leader) ]
     |
     v
  [ Pairing ]
     |
     +-- member joins -> send keys -> [ Team Status ]
     |
     +-- timeout/cancel --------------> [ Team Status ]
```

---

## B4. è¸¢äººæµç¨‹ï¼ˆLeaderï¼‰

```
[ Team Home ]
     |
     v
[ Members ]
     |
     v
[ Member Detail ]
     |
     v
[ Kick Confirm ]
     |
     +-- confirm --> epoch rotate --> [ Team Status ]
```

---

# C. æ¶‰åŠçš„åè®®ï¼ˆPager Team Core v0.1ï¼‰

## C1. ???????????
| ?? | ?? |
| --- | --- |
| `TEAM_KEY_DIST` | ??????? ESP?NOW? |
| `TEAM_KICK` | ?????????? |
| `TEAM_TRANSFER_LEADER` | ?????????? |
| `TEAM_STATUS` | ?????????? |
| `TEAM_POS` | ???????? |
| `TEAM_WAYPOINT` | ???????? |
| `TEAM_TRACK` | ???????? |
| `TEAM_CHAT` | ?????????? |

> v0.2 ?????/???? ESP?NOW ??????LoRa ???? Join Handshake?
---

## C2. å­—æ®µå‘½åå®šç¨¿ï¼šepoch / event_seq / msg_id

ä¸ºäº†é¿å…å®ç°è¸©é›·ï¼Œæ˜ç¡®ï¼š

* `epoch`ï¼š**å¯†é’¥è½®æ¬¡**ï¼ˆåŠ è§£å¯† key é€‰æ‹©ï¼‰
* `event_seq`ï¼š**å…³é”®äº‹ä»¶åºå·**ï¼ˆä»… Key Events ä¸ Sync ä½¿ç”¨ï¼Œå•è°ƒé€’å¢ï¼‰
* `msg_id`ï¼š**æ™®é€šåŒ…å»é‡æ ‡è¯†**ï¼ˆå¯é€‰ï¼Œv0.1 å¯ä¸åšï¼‰

---

## C3. TeamEnvelopeï¼ˆæ‰€æœ‰ Team åŒ…ç»Ÿä¸€å¤–å£³ï¼Œv0.1ï¼‰

> `event_seq` åªåœ¨å…³é”®äº‹ä»¶æˆ– sync æ‰¿è½½äº‹ä»¶æ—¶å‡ºç°ï¼›
> Presence/Pos ä¸è¦æ±‚è¿ç»­ seqã€‚

```
TeamEnvelope {
  team_id
  epoch
  type
  sender_id
  timestamp
  msg_id?          // optional, v0.1 may omit
  auth             // AEAD tag or MAC (depends on encrypt/plain)
  payload
}
```

---

## C4. Key Eventsï¼ˆå†™å…¥ events.log çš„â€œç»“æ„çœŸç›¸â€ï¼‰

v0.1 å¿…é¡»è®°å½•çš„å…³é”®äº‹ä»¶ï¼š

* `TeamCreated(event_seq=1)`
* `MemberAccepted(event_seq++)`
* `MemberKicked(event_seq++)`
* `LeaderTransferred(event_seq++)`
* `EpochRotated(event_seq++)`

> Key Events æ˜¯ Sync çš„ä¾æ®ï¼›Presence/Pos/Chat ä¸å±äº Key Eventsã€‚

---

# D. åè®®æµè½¬ï¼ˆå’Œ UI çš„å¯¹åº”å…³ç³»ï¼‰

## D1. Create (ESP?NOW)

* æœ¬åœ°ç”Ÿæˆ `team_id`
* `epoch = 1`
* self = leader
* ç”Ÿæˆ `team_key(epoch=1)`
* è¿½åŠ  key eventï¼š`TeamCreated(event_seq=1)`
* å†™ snapshot + events.log

---

## D2. Pairing / Join?ESP?NOW?

**Beacon?Leader?**

- Leader ?? Pairing ??????? Beacon
- Beacon ?? team_id / key_id / leader_id / team_name????

**Join & KeyDist?Member?**

1. Member ?? Beacon ??? Join ??
2. Leader ???? ESP?NOW ?? TEAM_KEY_DIST
3. Member ?? key ??? Joined??? LoRa ??? Team ??

---

## E2. å¹¶å‘ Join å¤„ç†ç­–ç•¥ï¼ˆLeaderï¼‰

* Leader åŒæ—¶åªå¤„ç† **1 ä¸ª pending join**

\r\n
# 1) æ¨¡å—æ¸…å•ï¼ˆå·¥ç¨‹å†…ç›®å½•ä¸èŒè´£ï¼‰

## 1.1 å»ºè®®ç›®å½•ç»“æ„

```
src/team/
  domain/
    team_types.h
    team_model.h/.cpp
    team_events.h
    team_policy.h
    team_crypto.h
    team_codec.h         // Envelope ç¼–è§£ç ï¼ˆçº¯å‡½æ•°ï¼‰

  usecase/
    team_service.h/.cpp  // å…¥å£ç¼–æ’ï¼šUIåŠ¨ä½œ + RadioåŒ… + å­˜å‚¨
    team_pairing_service.h/.cpp
    team_admin_flow.h/.cpp
    team_sync_flow.h/.cpp
    team_presence_flow.h/.cpp

  ports/
    i_team_store.h       // æŒä¹…åŒ–ï¼šsnapshot + event log
    i_team_transport.h   // å‘é€/æ¥æ”¶ Team åŒ…ï¼ˆåŸºäº Meshtastic portnumï¼‰
    i_team_crypto.h      // ç”Ÿæˆ/æ´¾ç”Ÿ/åŠ è§£å¯†/MACï¼ˆå¯åœ¨ domain é‡Œåšï¼Œä½†å»ºè®® portï¼‰
    i_clock.h            // æ—¶é—´æˆ³ï¼ˆå¯å¤ç”¨ç³»ç»Ÿå·²æœ‰ï¼‰
    i_rng.h              // éšæœºæ•°ï¼ˆteam_id / keyï¼‰
    i_ui_notifier.h      // å¼¹çª—/Toast/é¡µé¢è·³è½¬äº‹ä»¶ï¼ˆå¯é€‰ï¼‰

  infra/
    meshtastic/
      mt_team_transport.h/.cpp   // ç»‘å®š IMeshAdapter / portnum
    store/
      team_store_flash.h/.cpp    // Preferences/Flash
      team_store_sd.h/.cpp       // å¯é€‰ï¼šSD eventlog
    crypto/
      team_crypto_impl.h/.cpp    // AES/ChaCha + HMAC ç­‰

  ui/
    screens/team/
      team_state.h/.cpp          // UI stateï¼šå½“å‰é¡µã€åˆ—è¡¨æ•°æ®ã€loading/err
      team_pages.h/.cpp          // enter/exit, render
      team_input.h/.cpp          // æŒ‰é”®/æ—‹é’®æ˜ å°„ä¸º action
      team_components.h/.cpp     // list item, modal, bottom actions
      team_nav.h/.cpp            // ç®€å•å¯¼èˆªï¼ˆStatus/Home/Pairing...ï¼‰
```

> ä½ å¦‚æœå·²ç»æœ‰ â€œscreens/xxx/ layout/components/input/stateâ€ çš„èŒƒå¼ï¼Œå°±å®Œå…¨æŒ‰é‚£å¥—å¥—è¿›å»ã€‚

---

## 1.2 å…³é”®èŒè´£è¾¹ç•Œ

### Domainï¼ˆçº¯é€»è¾‘ï¼‰

* **TeamModel**ï¼šåªåšçŠ¶æ€æœº + äº‹ä»¶åº”ç”¨ï¼ˆapply eventï¼‰
* **TeamEventLog**ï¼šäº‹ä»¶åºå·ã€é‡æ”¾ã€å»é‡ï¼ˆåªå®šä¹‰ç»“æ„ï¼Œä¸åš IOï¼‰
* **Policy**ï¼šè¶…æ—¶é˜ˆå€¼ã€invite TTLã€presence å‘¨æœŸç­‰ï¼ˆUI/é…ç½®å±‚å¯æ”¹ï¼‰
* **Codec**ï¼šTeamEnvelope + payload çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼ˆä¸ç¢° radioï¼‰

> Domain ç»ä¸ç›´æ¥â€œå‘åŒ…/å­˜ç›˜/å¼¹ UIâ€ã€‚

### Usecaseï¼ˆç¼–æ’ï¼‰

* æ¥æ”¶ UI action â†’ è°ƒ domain â†’ è°ƒ portsï¼ˆtransport/store/cryptoï¼‰
* æ¥æ”¶ radio packet â†’ decode â†’ éªŒè¯/è§£å¯† â†’ apply â†’ å¿…è¦æ—¶ sync/å›åŒ…
* è¾“å‡º UI éœ€è¦çš„æ´¾ç”Ÿæ•°æ®ï¼šteam healthã€member listã€security çŠ¶æ€

### Ports/Infra

* transportï¼šæŠŠ â€œTeamPacket bytesâ€ å‘åˆ° Meshtastic
* storeï¼ševentlog appendã€snapshot load/save
* cryptoï¼škey æ´¾ç”Ÿã€encrypt/decryptã€MAC æ ¡éªŒ
* clock/rngï¼šæä¾›å¯æµ‹æ›¿èº«ï¼ˆå•æµ‹ã€ä»¿çœŸï¼‰

### UI

* é¡µé¢åªå…³å¿ƒ **æ˜¾ç¤ºçŠ¶æ€** + **å‘ action**
* UI ä¸åš join/kick çš„ä¸šåŠ¡åˆ¤æ–­ï¼ˆæ¯”å¦‚ epoch rotate å¿…é¡»ç”± usecase åšï¼‰

---

# 2) é¢†åŸŸæ¨¡å‹ï¼ˆDomainï¼‰æœ€å°å®šä¹‰

## 2.1 Team çŠ¶æ€ï¼ˆåªåŒ…å« v0.1 å¿…éœ€ï¼‰

```cpp
enum class TeamRole : uint8_t { Leader, Member, None };

enum class TeamSecurityState : uint8_t {
  OK,        // epochåŒ¹é…ä¸”å¯è§£å¯†
  WARN,      // éœ€è¦syncæˆ–å‘ç°epochå·®å¼‚ä½†å°šèƒ½å·¥ä½œ
  FAIL       // è§£å¯†å¤±è´¥/è¢«è¸¢/å¯†é’¥ç¼ºå¤±
};

struct TeamId { std::array<uint8_t,16> bytes; };
struct MemberId { uint32_t node_id; };

struct MemberInfo {
  MemberId id;
  std::string name;        // å¯é€‰
  TeamRole role;           // Leader/Member
  uint32_t last_seen_ts;   // ç§’
  uint32_t caps;           // ä½æ ‡å¿—ï¼špos/wp/sync
};

struct TeamState {
  bool in_team = false;
  TeamId team_id;
  uint32_t epoch = 0;
  TeamRole self_role = TeamRole::None;
  MemberId leader_id;

  // å…³é”®ï¼šæˆå‘˜é›†åˆï¼ˆä»¥äº‹ä»¶é‡æ”¾å¾—åˆ°ï¼‰
  std::vector<MemberInfo> members;

  // äº‹ä»¶åºå·ï¼ˆç”¨äºsyncï¼‰
  uint32_t last_event_seq = 0;

  // å®‰å…¨æ€
  TeamSecurityState security = TeamSecurityState::FAIL;
};
```

## 2.2 å…³é”®äº‹ä»¶ï¼ˆå¯é‡æ”¾ï¼‰

```cpp
enum class TeamEventType : uint8_t {
  TeamCreated,
  MemberAccepted,
  MemberKicked,
  LeaderTransferred,
  EpochRotated,
  // v0.1 ä¸åšï¼šå¤æ‚æƒé™/å¯¹è±¡
};

struct TeamEvent {
  uint32_t event_seq;      // å•è°ƒé€’å¢ï¼ˆleaderä¸ºæƒå¨æºï¼‰
  uint32_t ts;
  TeamEventType type;
  // payload: member_id, new_leader, new_epoch ...
};
```

## 2.3 TeamModelï¼šå”¯ä¸€çš„â€œçœŸç›¸æ›´æ–°å…¥å£â€

```cpp
class TeamModel {
public:
  TeamState s;

  // apply must be pure: no IO
  void apply(const TeamEvent& e);

  // derived
  bool isLeader() const;
  bool isMember() const;
  const MemberInfo* findMember(MemberId id) const;
};
```

---

# 3) Usecase ç¼–æ’ï¼ˆæ ¸å¿ƒ service + flowsï¼‰

## 3.1 TeamService / PairingService

- TeamService ?? LoRa ?? Team ???status/pos/track/chat?
- TeamPairingService ?? ESP?NOW ?????Leader beacon / Member join / KeyDist?
- UI ?????Create (ESP?NOW) / Start Pairing / Stop Pairing / Leave / Kick / Transfer Leader
- Pairing ?? Pairing ????

---

# 4) çŠ¶æ€æœºä¼ªä»£ç ï¼ˆUI ä¸åè®®éƒ½åœ¨è¿™é‡Œé—­ç¯ï¼‰

ä¸‹é¢ç»™ä¸¤å¥—çŠ¶æ€æœºï¼š

* **UI é¡µé¢çŠ¶æ€æœº**ï¼ˆä½  LVGL é¡µé¢çš„æµè½¬ï¼‰
* **åè®®/ä¸šåŠ¡çŠ¶æ€æœº**ï¼ˆjoin/kick/rotate/sync çš„çœŸå®é€»è¾‘ï¼‰

---

## 4.1 UI é¡µé¢çŠ¶æ€æœºï¼ˆTeam Screen Navigationï¼‰

### UI çŠ¶æ€

```cpp
enum class TeamPage {
  StatusNotInTeam,
  StatusInTeam,
  TeamHome,
  JoinPending, // Pairing page
  Members,
  MemberDetail,
  KickConfirm,
  KickedOut
};

struct TeamUiState {
  TeamPage page;
  // selections
  int selected_member_index = -1;
  MemberId selected_member;
  // join temp
  std::string join_code;
  // flags
  bool busy = false;
  std::string toast;
};
```

### é¡µé¢æµè½¬ä¼ªä»£ç ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰

```cpp
// called when entering Team menu
void TeamUI::enter() {
  auto s = teamService.snapshot();
  if (!s.in_team) navTo(StatusNotInTeam);
  else navTo(StatusInTeam);
}

// StatusNotInTeam
onClick(CreateTeam) { teamService.uiCreateTeam(); pairing.startLeader(); navTo(JoinPending); }
onClick(JoinTeam)   { pairing.startMember(); navTo(JoinPending); }

// StatusInTeam
onClick(ViewTeam)    { navTo(TeamHome); }
onClick(PairMember) { pairing.startLeader(); navTo(JoinPending); }
onClick(Leave)       { teamService.uiLeaveTeam(); navTo(StatusNotInTeam); }

// TeamHome
onClick(PairMember) { pairing.startLeader(); navTo(JoinPending); }
onClick(Manage)     { if (isLeader) navTo(Members); }
onClick(Leave)      { ... }

// JoinPending (Pairing)
onClick(Cancel) { pairing.stop(); navTo(previous); }
onClick(Retry)  { pairing.restart(); }

// Members
onSelect(Member) { ui.selected_member=...; navTo(MemberDetail); }

// MemberDetail
onClick(Kick) { navTo(KickConfirm); }
onClick(TransferLeader) { teamService.uiTransferLeader(ui.selected_member); navTo(TeamHome); }

// KickConfirm
onClick(ConfirmKick) { teamService.uiKickMember(ui.selected_member); navTo(StatusInTeam); }

// KickedOut
onClick(JoinAnother) { navTo(StatusNotInTeam); }
onClick(OK) { navTo(StatusNotInTeam); }
```

### UI ? service ???

UI ????? Join/Pair Member ???????

* `uiCreateTeam()`
* `startPairingLeader()/startPairingMember()`
* `stopPairing()`
* `uiLeaveTeam()` / `uiKickMember()` / `uiTransferLeader()`

---



## 4.2 ??/??????Pairing & KeyDist?

### 4.2.1 ESP?NOW Pairing ??

- Leader??? Pairing ?? -> ?? Beacon -> ?? Join ??? TEAM_KEY_DIST
- Member??? Beacon -> Join Sent -> Waiting Key -> Joined
- ??????? / ?? -> ?? StatusNotInTeam

### 4.2.2 KeyDist ??

- ?? TEAM_KEY_DIST ??? key??? snapshot??? Joined

---

## 4.2.10 Kick Flowï¼ˆLeader â†’ å…¨é˜Ÿï¼‰

```cpp
void TeamService::uiKickMember(MemberId target) {
  if (!model_.isLeader()) return;

  // 1) event: MemberKicked(target)
  appendEventAndApply(makeMemberKickedEvent(target));

  // 2) epoch rotate
  rotateEpoch();

  // 3) broadcast kick + epoch rotate markerï¼ˆå¯åˆå¹¶æˆä¸€ä¸ª control åŒ…ï¼‰
  transport_.send(encodeKick(model_.s.team_id, model_.s.epoch, target));

  // 4) distribute new key to remaining members
  distributeEpochKeyToMembers();
}
```

### è¢«è¸¢æˆå‘˜çš„å¤„ç†ï¼ˆMember ä¾§ï¼‰

```cpp
void TeamService::onKick(const Kick& k) {
  if (!model_.s.in_team) return;
  if (k.target != selfNodeId()) {
    // å…¶ä»–äººè¢«è¸¢ï¼šapplyäº‹ä»¶ã€ç­‰å¾…keyæ›´æ–°
    appendEventAndApply(makeMemberKickedEvent(k.target));
    model_.s.security = TeamSecurityState::WARN;
    return;
  }

  // è‡ªå·±è¢«è¸¢ï¼šç«‹å³å¤±æ•ˆ
  model_.s.in_team = false;
  model_.s.security = TeamSecurityState::FAIL;
  crypto_.wipeTeamKeys(model_.s.team_id);
  store_.clearTeam(); // æˆ–æ ‡è®° revoked
  ui_->navToKickedOut();
}
```

---

## 4.2.11 Presence & Healthï¼ˆçŠ¶æ€é¡µæ•°æ®æ¥æºï¼‰

```cpp
void TeamService::broadcastPresenceIfDue() {
  if (!model_.s.in_team) return;
  if (clock_.now() - last_presence_ts < policy.presence_period_s) return;

  auto pkt = encodePresence(model_.s.team_id, model_.s.epoch,
                           selfNodeId(),
                           /*event_seq*/ model_.s.last_event_seq,
                           /*battery*/ readBattery(),
                           /*fix*/ gpsFix());
  transport_.send(pkt);
  last_presence_ts = clock_.now();
}

void TeamService::onPresence(const Presence& p) {
  if (!acceptTeam(p.team_id)) return;

  // epoch mismatch: warn + possible sync
  if (p.epoch != model_.s.epoch) {
    model_.s.security = TeamSecurityState::WARN;
    maybeSync(p);
  }

  updateMemberLastSeen(p.sender, p.ts);
  if (p.event_seq > model_.s.last_event_seq) {
    requestSyncFrom(p.sender, model_.s.last_event_seq + 1);
  }
}
```

---

## 4.2.12 Syncï¼ˆè¡¥é½å…³é”®äº‹ä»¶ï¼‰

```cpp
void TeamService::requestSyncFrom(MemberId peer, uint32_t from_seq) {
  auto req = encodeSyncReq(model_.s.team_id, model_.s.epoch, from_seq);
  transport_.sendTo(peer, req);
}

void TeamService::onSyncReq(const SyncReq& r, MemberId from) {
  // ä» store æ‹‰æœ€è¿‘Næ¡ event å›åŒ…
  auto events = store_.readEventsFrom(r.from_seq, policy.sync_max_events);
  transport_.sendTo(from, encodeSyncRsp(model_.s.team_id, model_.s.epoch, events));
}

void TeamService::onSyncRsp(const SyncRsp& rsp) {
  for (auto& e : rsp.events) {
    if (e.event_seq <= model_.s.last_event_seq) continue;
    model_.apply(e);
    store_.appendEvent(e);
  }
  store_.saveSnapshot(model_.s);
  model_.s.security = TeamSecurityState::OK;
}
```

---

# 5) UI ä¸åè®®â€œå¯¹é½ç‚¹æ¸…å•â€ï¼ˆä½ è½åœ°æ—¶æœ€æœ‰ç”¨ï¼‰

## 5.1 ??????? usecase

* StatusNotInTeam?Create ? `uiCreateTeam()` + `startPairingLeader()`?Join ? `startPairingMember()`
* JoinPending?Pairing??Cancel ? `stopPairing()`?Retry ? `startPairing...()`
* StatusInTeam / TeamHome?Pair Member ? `startPairingLeader()`
* Members/Detail/KickConfirm?Kick/Transfer ? `uiKickMember()/uiTransferLeader()`
* KickedOut?Join Another ? ? StatusNotInTeam

## 5.2 é¡µé¢å­—æ®µæ¥è‡ªå“ªé‡Œ

* Members/Onlineï¼š`TeamService.snapshot()`
* Security OK/WARN/FAILï¼šæ¥è‡ª

  * è§£å¯†æˆåŠŸä¸å¦ï¼ˆcryptoï¼‰
  * epoch æ˜¯å¦ä¸€è‡´ï¼ˆpresence/æ§åˆ¶åŒ…ï¼‰
  * sync æ˜¯å¦å®Œæˆ
* Last updateï¼šæ¥è‡ª

  * æœ€è¿‘ä¸€æ¬¡ presence/æ§åˆ¶äº‹ä»¶å¤„ç†æ—¶é—´

---

# 6) ä½ å¯ä»¥ç›´æ¥ç…§è¿™ä¸ªå¼€å·¥çš„â€œç¬¬ä¸€æ‰¹æ–‡ä»¶â€

å¦‚æœä½ æƒ³æœ€å¿«æŠŠéª¨æ¶è·‘èµ·æ¥ï¼Œæˆ‘å»ºè®®æŒ‰è¿™ä¸ªé¡ºåºå»ºæ–‡ä»¶ï¼š

1. `domain/team_types.h` + `domain/team_events.h`
2. `domain/team_model.cpp`ï¼ˆapply äº‹ä»¶ï¼‰
3. `ports/i_team_transport.h`ï¼ˆsend / sendTo / onPacketï¼‰
4. `usecase/team_service.cpp`ï¼ˆå…ˆåªåš create + invite å¹¿æ’­ + presenceï¼‰
5. `ui/screens/team/team_state.h` + `team_pages.cpp`ï¼ˆStatusNotInTeam / StatusInTeam ä¸¤é¡µå…ˆè·‘èµ·æ¥ï¼‰
6. å†åŠ  join/kick/sync
